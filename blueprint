blueprint:
  name: Blueberry MQTT Control
  description: Sends MQTT messages to specified Blueberry computers with action and parameters.
  domain: automation
  input:
    custom_trigger:
      name: Trigger
      description: The trigger for this automation.
      trigger:
    blueberry_name:
      name: Blueberry Name
      description: "Enter 'blueberry' for all or specify comma-separated names (e.g., blueberry01, blueberry02)."
      selector:
        text: {}
    action_field:
      name: Action
      description: Action to be included in the JSON string.
      selector:
        text: {}
    additional_params:
      name: Additional Parameters
      description: Additional parameters in JSON format, newline-separated.
      selector:
        text:
          multiline: true
          
action:
  - variables:
      blueberry_list: "{{ blueberry_name.split(',') }}"
      base_topic: "home/"
      action_topic: "/action"
  - choose:
      - conditions: "{{ 'blueberry' in blueberry_name }}"
        sequence:
          - repeat:
              count: "{{ range(1, 99) | length }}"
              sequence:
                - variables:
                    current_blueberry: "blueberry{{ '%02d' | format(repeat.index) }}"
                - service: mqtt.publish
                  data:
                    topic: "{{ base_topic ~ current_blueberry ~ action_topic }}"
                    payload: >
                      {%
                        set payload = {'action': action_field} |
                        update(additional_params | from_json | default({}))
                      %}
                      {{ payload | tojson }}
      - conditions: "{{ 'blueberry' not in blueberry_name }}"
        sequence:
          - repeat:
              foreach: "{{ blueberry_list }}"
              sequence:
                - service: mqtt.publish
                  data:
                    topic: "{{ base_topic ~ repeat.item ~ action_topic }}"
                    payload: >
                      {%
                        set payload = {'action': action_field} |
                        update(additional_params | from_json | default({}))
                      %}
                      {{ payload | tojson }}
