blueprint:
  name: Blueberry MQTT Control
  description: Sends MQTT messages to specified Blueberry computers with action and parameters.
  domain: automation
  input:
    trigger:
      name: Trigger
      description: The trigger for this automation.
      selector:
        entity: {}
    blueberry_name:
      name: Blueberry Name
      description: "Comma-separated blueberry computer names (e.g., blueberry01, blueberry02), or 'blueberry' for all."
      selector:
        text: {}
    action_field:
      name: Action
      description: Action to be included in the JSON string.
      selector:
        text: {}
    additional_params:
      name: Additional Parameters
      description: Additional parameters in JSON format, newline-separated.
      selector:
        text:
          multiline: true

variables:
  blueberry_names: >-
    {% if blueberry_name == 'blueberry' %}
    {% set ns = namespace(numbers=[]) %}
    {% for i in range(1, 100) %}
    {% set ns.numbers = ns.numbers + ['blueberry%02d' | format(i)] %}
    {% endfor %}
    {{ ns.numbers }}
    {% else %}
    {{ blueberry_name.split(',') }}
    {% endif %}
  action_json: >-
    {
      "action": "{{ action_field }}",
      {% set params = additional_params.split('\n') %}
      {% for param in params %}
      "{{ param.split(':')[0] }}": "{{ param.split(':')[1] }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    }

action:
  - choose:
      - conditions: "{{ 'blueberry' in blueberry_names }}"
        sequence:
          - repeat:
              sequence:
                - service: mqtt.publish
                  data:
                    topic: "home/{{ blueberry_names[repeat.index-1] }}/action"
                    payload: "{{ action_json | tojson }}"
              count: "{{ blueberry_names | length }}"
      - conditions: "{{ 'blueberry' not in blueberry_names }}"
        sequence:
          - service: mqtt.publish
            data_template:
              topic: "home/{{ blueberry_name }}/action"
              payload: "{{ action_json | tojson }}"
